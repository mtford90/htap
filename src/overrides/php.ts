import * as fs from "node:fs";
import * as path from "node:path";

/**
 * Generate the contents of a httap.ini file that configures PHP's
 * curl and OpenSSL extensions to trust the proxy CA certificate.
 *
 * PHP INI directives don't require quotes around values.
 */
export function generatePhpOverrideIni(caCertPath: string): string {
  return [
    "; Generated by httap â€” ensures PHP trusts the proxy CA certificate",
    `curl.cainfo=${caCertPath}`,
    `openssl.cafile=${caCertPath}`,
    "",
  ].join("\n");
}

/**
 * Write the httap.ini file to the given directory (typically
 * `.httap/php/`). Creates parent directories if needed.
 *
 * Returns the directory path (for use in PHP_INI_SCAN_DIR).
 */
export function writePhpOverride(outputDir: string, caCertPath: string): string {
  fs.mkdirSync(outputDir, { recursive: true });
  const iniPath = path.join(outputDir, "httap.ini");
  fs.writeFileSync(iniPath, generatePhpOverrideIni(caCertPath), "utf-8");
  return outputDir;
}
